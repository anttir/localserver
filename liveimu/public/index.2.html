<html>

<head>
    <title>Live telemetry</title>
    <!-- The following meta line optimizes the site for mobile devices. It sets the viewport size to the screen size, so it will be displayed maximized, but unscaled. -->
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <script type="text/javascript" src="jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <style>
        .graph .axis {
            stroke-width: 1;
        }

            .graph .axis .tick line {
                stroke: black;
            }

            .graph .axis .tick text {
                fill: black;
                font-size: 0.7em;
            }

            .graph .axis .domain {
                fill: none;
                stroke: black;
            }

        .graph .group {
            fill: none;
            stroke: black;
            stroke-width: 1.5;
        }
    </style>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/three.js/r69/three.js"></script>
    <script src="threejs_renderer.js"></script>
</head>

<body>
    <div id="WebGLCanvas"></div>
    <div class="button" id="pauseChart">pause</div>
    <div id="lineGraph" class="graph"></div>
    <div id="rotationGraph"></div>
    <div class="button" id="pauseTable">pause</div>
    <div id="tableDiv">
        <table id="dataTable">
            <thead>
                <tr>
                    <th class="dataCell">Accel X</th>
                    <th class="dataCell">Accel Y</th>
                    <th class="dataCell">Accel Z</th>
                    <th class="dataCell">Rotation X</th>
                    <th class="dataCell">Rotation Y</th>
                    <th class="dataCell">Rotation Z</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        var groupNames = ['Timestamp', 'AccelX', 'AccelY', 'AccelZ', 'RotationX', 'RotationY', 'RotationZ'];
        var TIMESTAMP = 'Timestamp';

        var c10 = d3.scale.category10();

        var samples = 500;
        var rowsToKeep = 10;
        var timeStamps = Array(samples);
        var time = new Date();
        timeStamps.fill(time.getTime());

        var pauseTable = false;
        var pauseChart = false;

        var width = 500,
            height = 200;

        var groups = {};
        for (i = 0; i < groupNames.length ; i++) {
            groups[groupNames[i]] = {
                value: 0,
                color: c10(i),
                data: Array(samples).fill([time, 0])
            };
        }

        function isNumeric(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }

        $(function () {

            $("#pauseTable,#pauseChart").click(function (e) {
                window[this.id] = !window[this.id];
                if (window[this.id]) {
                    $(this).text("resume")
                } else {
                    $(this).text("pause")
                }
            })

            if (!!window.EventSource) {
                // Good example on using SSE
                // http://www.html5rocks.com/en/tutorials/eventsource/basics/

                var source = new EventSource('data');
                source.addEventListener('message', function (e) {
                    // Split the comma-separated list of values into an array of values
                    var data = e.data.split(",").map(function (d) { return Number(d) || null });
                    data.unshift(Date.now());
                    tick(data);
                }, false);
            }
            else {
                console.log('sse not supported');
            }

            // kirjoitetaan sarakeotsikot
            $("#dataTable thead tr").html(groupNames.map(function (d) { return "<th>" + d + "</th>"; }).join(""))
        });



        var x = d3.time.scale()
            .domain([timeStamps[0], timeStamps[timeStamps.length - 1]])
            //.domain([time, new Date(time.getTime() + 2 * 60000)]) // add 5 minutes
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([-20000, 20000])
            .range([height, 0])

        var line = d3.svg.line()
            .interpolate('basis')
            .defined(function (d) { return !isNaN(d[1]); })
            .x(function (d, i) {
                return x(d[0]);
            })
            .y(function (d) {
                return y(d[1]);
            })

        var svg = d3.select('#lineGraph').append('svg')
            .attr('class', 'chart')
            .attr('width', width)
            .attr('height', height + 50)

        var axis = svg.append('g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + height + ')')
            .call(x.axis = d3.svg.axis().scale(x).orient('bottom'))

        var paths = svg.append('g')

        for (var name in groups) {
            var group = groups[name]
            group.path = paths.append('path')
                .data([group.data])
                .attr('class', name + ' group')
                .style('stroke', group.color)
        }
        /** @description Updates the screen with new data
         * @param {data} Array of integer values
         * @return {null} Nothing
         */
        function tick(data) {
            if (data && data.length == groupNames.length) {
                if (!pauseTable) {
                    // p‰ivitet‰‰n taulukko
                    var rowCount = $('#dataTable > tbody > tr').length;
                    if ((rowCount + 1) >= rowsToKeep) {
                        // After adding rows, there will be too many, remove last
                        $('#dataTable > tbody > tr:last').remove();
                    }
                    // Prepare a row
                    var html = '<tr>';
                    for (var ii = 0; ii < data.length; ii++) {
                        html += '<td>' + data[ii] + '</td>';
                    }
                    html += '</tr>';
                    // Insert at the beginning
                    $(html).prependTo("#dataTable > tbody");
                }

                // p‰ivitet‰‰n kuvaaja
                if (!pauseChart) {
                    now = new Date();
                    // update Timestamps
                    var time = parseInt(data[0]);
                    timeStamps.push(time);
                    timeStamps.shift();

                    var currData = {};

                    // Add new values
                    for (i = 1; i < groupNames.length; i++) {
                        var name = groupNames[i];
                        currData[name] = data[i];
                        var group = groups[name];
                        group.data.push([time, data[i]]);
                        group.path.attr('d', line);
                    }

                    // Shift axis domain and update axis
                    x.domain([timeStamps[0], time]);
                    axis.call(x.axis);

                    // Remove oldest data point from each group
                    for (var name in groups) {
                        var group = groups[name]
                        group.data.shift()
                    }


                    // lasketaan asento

                    var R = Math.sqrt(Math.pow(currData.AccelX, 2) + Math.pow(currData.AccelY, 2) + Math.pow(currData.AccelZ, 2));
                    var Arx = Math.acos(currData.AccelX / R) * 180 / Math.PI;
                    var Ary = Math.acos(currData.AccelY / R) * 180 / Math.PI;
                    var Arz = Math.acos(currData.AccelZ / R) * 180 / Math.PI;

                    $("#rotationGraph").text(
                        "X" + Math.round(Arx) + " | " +
                        "Y" + Math.round(Ary) + " | " +
                        "Z" + Math.round(Arz)
                    );
                    rotateCube(Arx, Ary, Arz);
                }

            }

        }
    </script>

</body>

</html>